name: Deploy to TimeWeb.cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # –ö–æ–ø–∏—Ä—É–µ–º standalone —Å–±–æ—Ä–∫—É (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è output: 'standalone')
          if [ -d ".next/standalone" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è standalone —Ä–µ–∂–∏–º"
            cp -r .next/standalone/* deploy/
            cp -r .next/static deploy/.next/static
            cp -r public deploy/public
          else
            # –û–±—ã—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è —Å–±–æ—Ä–∫–∞"
            cp -r .next deploy/
            cp -r public deploy/
            cp package.json deploy/
            cp package-lock.json deploy/
            cp next.config.js deploy/
          fi

      - name: Deploy to TimeWeb.cloud via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          port: ${{ secrets.TIMEWEB_SSH_PORT || 22 }}
          source: "deploy/*"
          target: ${{ secrets.TIMEWEB_DEPLOY_PATH }}
          strip_components: 0

      - name: Execute remote commands
        uses: appleboy/ssh-action@v1.0.4
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          port: ${{ secrets.TIMEWEB_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.TIMEWEB_DEPLOY_PATH }}
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Å–±–æ—Ä–∫–∏
            if [ -f "server.js" ]; then
              echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω standalone —Ä–µ–∂–∏–º"
              # Standalone —Ä–µ–∂–∏–º - –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ node
              if command -v pm2 &> /dev/null; then
                echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2 (standalone)..."
                pm2 restart deztechug || pm2 start server.js --name "deztechug" --cwd "${{ secrets.TIMEWEB_DEPLOY_PATH }}"
                pm2 save
              else
                echo "PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: node server.js"
              fi
            else
              echo "–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Å–±–æ—Ä–∫–∏"
              # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º npm start
              if [ ! -d "node_modules" ]; then
                echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
                npm ci --production
              fi
              
              if command -v pm2 &> /dev/null; then
                echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2..."
                pm2 restart deztechug || pm2 start npm --name "deztechug" -- start
                pm2 save
              else
                echo "PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ."
              fi
            fi
            
            echo "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

      - name: Deployment success notification
        if: success()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ TimeWeb.cloud –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ TimeWeb.cloud"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
